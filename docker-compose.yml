x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

services:
  # ==========================================================================
  # Database
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: erp-postgres
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: securepassword123
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./infrastructure/postgres-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging: *default-logging
    networks:
      - erp-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
      restart_policy:
        condition: on-failure

  # ==========================================================================
  # .NET Services
  # ==========================================================================
  user-service:
    image: ghcr.io/jctroth/erp-user-service:latest
    container_name: erp-user-service
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://*:5000
      ConnectionStrings__DefaultConnection: Host=postgres;Port=5432;Database=userdb;Username=erp_user;Password=${DB_PASSWORD:-RaxhWee5Pei1e}
      JWT__Secret: your-jwt-secret-key-here-make-it-long-and-secure
      JWT__Issuer: erp-system
      JWT__Audience: erp-clients
      Database__EnableSeeding: "true"
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - erp-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  shop-service:
    image: ghcr.io/jctroth/erp-shop-service:latest
    container_name: erp-shop-service
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://*:5003
      ConnectionStrings__DefaultConnection: Host=postgres;Port=5432;Database=shopdb;Username=erp_shop;Password=${DB_PASSWORD:-RaxhWee5Pei1e}
      Database__EnableSeeding: "true"
      Minio__Endpoint: minio:9000
      Minio__AccessKey: minioadmin
      Minio__SecretKey: minioadmin
      Minio__UseSSL: "false"
      Minio__PublicUrl: https://${DEPLOY_DOMAIN:-shopping-now.net}/minio
      Services__TemplatesService: http://templates-service:8087
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - erp-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  accounting-service:
    image: ghcr.io/jctroth/erp-accounting-service:${IMAGE_VERSION:-1.4}
    container_name: erp-accounting-service
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__DefaultConnection: Host=postgres;Port=5432;Database=accountingdb;Username=erp_accounting;Password=${DB_PASSWORD:-RaxhWee5Pei1e}
      Database__EnableSeeding: "true"
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - erp-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  masterdata-service:
    image: erp-system-masterdata-service:latest
    container_name: erp-masterdata-service
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__DefaultConnection: Host=postgres;Port=5432;Database=masterdatadb;Username=erp_masterdata;Password=${DB_PASSWORD:-RaxhWee5Pei1e}
      Database__EnableSeeding: "true"
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - erp-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  orders-service:
    image: ghcr.io/jctroth/erp-orders-service:latest
    container_name: erp-orders-service
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://*:5004
      ConnectionStrings__DefaultConnection: Host=postgres;Port=5432;Database=ordersdb;Username=erp_orders;Password=${DB_PASSWORD:-RaxhWee5Pei1e}
      Database__EnableSeeding: "true"
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - erp-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  # ==========================================================================
  # Java Services
  # ==========================================================================
  company-service:
    image: ghcr.io/jctroth/erp-company-service:latest
    container_name: erp-company-service
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/companydb
      SPRING_DATASOURCE_USERNAME: erp_company
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-RaxhWee5Pei1e}
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ""
      SPRING_AUTOCONFIGURE_EXCLUDE: org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - erp-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure

#  edifact-service:
#    image: ghcr.io/jctroth/erp-edifact-service:latest
#    container_name: erp-edifact-service
#    environment:
#      SPRING_PROFILES_ACTIVE: prod
#      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/erp_edifact
#      SPRING_DATASOURCE_USERNAME: erp_edifact
#      SPRING_DATASOURCE_PASSWORD: postgres
#    depends_on:
#      postgres:
#        condition: service_healthy
#    logging: *default-logging
#    networks:
#      - backend
#    deploy:
#      resources:
#        limits:
#          cpus: '1.0'
#          memory: 1G
#        reservations:
#          cpus: '0.5'
#          memory: 512M
#      restart_policy:
#        condition: on-failure

  notification-service:
    image: ghcr.io/jctroth/erp-notification-service:latest
    container_name: erp-notification-service
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/notificationdb
      SPRING_DATASOURCE_USERNAME: erp_notification
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-RaxhWee5Pei1e}
      SMTP_HOST: smtp.example.com
      SMTP_PORT: 587
      SMTP_USERNAME: your-email@example.com
      SMTP_PASSWORD: your-smtp-password
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - erp-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  translation-service:
    build:
      context: ./apps/services/java/translation-service
    image: ghcr.io/jctroth/erp-translation-service:latest
    container_name: erp-translation-service
    ports:
      - "8081:8081"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/translationdb
      SPRING_DATASOURCE_USERNAME: erp_translation
      SPRING_DATASOURCE_PASSWORD: postgres
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - erp-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  scripting-service:
    build:
      context: ./apps/services/java/scripting-service
    image: ghcr.io/jctroth/erp-scripting-service:latest
    container_name: erp-scripting-service
    profiles:
      - scripting  # Only start with: docker compose --profile scripting up
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/scriptingdb
      SPRING_DATASOURCE_USERNAME: erp_scripting
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-RaxhWee5Pei1e}
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - erp-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  # ==========================================================================
  # Node.js Services
  # ==========================================================================
  templates-service:
    build: ./apps/services/nodejs/templates-service
    image: ghcr.io/jctroth/erp-templates-service:latest
    container_name: erp-templates-service
    ports:
      - "8087:8087"
    environment:
      NODE_ENV: production
      PORT: 8087
      DATABASE_URL: postgresql://erp_templates:${DB_PASSWORD:-RaxhWee5Pei1e}@postgres:5432/templatesdb
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - erp-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
      restart_policy:
        condition: on-failure

  # ==========================================================================
  # Gateway & Frontend
  # ==========================================================================
  gateway:
    build: ./apps/gateway
    image: erp-system-gateway:latest
    container_name: erp-gateway
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: production
      PORT: 4000
      HOST: 0.0.0.0
      HOSTNAME: 0.0.0.0
      LISTEN_HOST: 0.0.0.0
      JWT_SECRET: your-jwt-secret-key-here-make-it-long-and-secure
      USER_SERVICE_URL: http://user-service:5000/graphql/
      SHOP_SERVICE_URL: http://shop-service:5003/graphql/
      ACCOUNTING_SERVICE_URL: http://accounting-service:5001/graphql/
      MASTERDATA_SERVICE_URL: http://masterdata-service:5002/graphql/
      ORDERS_SERVICE_URL: http://orders-service:5004/graphql/
      COMPANY_SERVICE_URL: http://company-service:8080/graphql
      TRANSLATION_SERVICE_URL: http://translation-service:8081/graphql
      NOTIFICATION_SERVICE_URL: http://notification-service:8082/graphql
    logging: *default-logging
    networks:
      - erp-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  frontend:
    image: ghcr.io/jctroth/erp-frontend:latest
    container_name: erp-frontend
    environment:
      VITE_API_URL: /graphql
      VITE_API_WS_URL: ws://${DEPLOY_DOMAIN:-shopping-now.net}:8088/graphql
    logging: *default-logging
    networks:
      - erp-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
        reservations:
          cpus: '0.5'
          memory: 128M
      restart_policy:
        condition: on-failure

  # ==========================================================================
  # Nginx Reverse Proxy
  # ==========================================================================
  nginx:
    image: nginx:alpine
    container_name: erp-nginx
    ports:
      - "8088:80"
    volumes:
      - /opt/erp-system/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /opt/erp-system/nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - frontend
      - gateway
    logging: *default-logging
    networks:
      - erp-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
  #       reservations:
  #         cpus: '0.25'
  #         memory: 128M
  #     restart_policy:
  #       condition: on-failure

  # ==========================================================================
  # Monitoring Services
  # ==========================================================================
  # Updated: 2026-01-26
  portainer:
    image: portainer/portainer-ce:latest
    container_name: erp-portainer
    ports:
      - "9443:9443"
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
      - /etc/letsencrypt/live/${DEPLOY_DOMAIN:-shopping-now.net}:/certs:ro
    command: --sslcert /certs/fullchain.pem --sslkey /certs/privkey.pem
    restart: always

  prometheus:
    image: prom/prometheus:latest
    container_name: erp-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./infrastructure/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./infrastructure/prometheus/web-config.yml:/etc/prometheus/web-config.yml
      - prometheus-data:/prometheus
      - /etc/letsencrypt/live/${DEPLOY_DOMAIN:-shopping-now.net}:/etc/prometheus/certs:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--web.config.file=/etc/prometheus/web-config.yml'
    restart: always

  grafana:
    image: grafana/grafana:latest
    container_name: erp-grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=erp-user
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_SERVER_PROTOCOL=https
      - GF_SERVER_CERT_FILE=/etc/grafana/certs/fullchain.pem
      - GF_SERVER_KEY_FILE=/etc/grafana/certs/privkey.pem
    volumes:
      - grafana-data:/var/lib/grafana
      - ./infrastructure/grafana/provisioning:/etc/grafana/provisioning
      - /etc/letsencrypt/live/${DEPLOY_DOMAIN:-shopping-now.net}:/etc/grafana/certs:ro
    restart: always

  # ==========================================================================
  # Infrastructure
  # ==========================================================================
  minio:
    image: minio/minio:RELEASE.2024-01-16T16-07-38Z
    container_name: erp-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      MINIO_SERVER_URL: https://${DEPLOY_DOMAIN:-shopping-now.net}
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD-SHELL", "mc alias set local http://localhost:9000 minioadmin minioadmin && mc admin info local --json | grep -q '\"status\":\"success\"' || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging: *default-logging
    networks:
      - erp-network

volumes:
  postgres-data:
  minio-data:
  prometheus-data:
  grafana-data:
  portainer_data:

networks:
  erp-network:
    driver: bridge
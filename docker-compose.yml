version: '3.8'

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

services:
  # ==========================================================================
  # Database
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: erp-postgres
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: securepassword123
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./infrastructure/postgres-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging: *default-logging
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
      restart_policy:
        condition: on-failure

  # ==========================================================================
  # .NET Services
  # ==========================================================================
  user-service:
    image: ghcr.io/jctroth/erp-user-service:latest
    container_name: erp-user-service
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://*:5000
      ConnectionStrings__DefaultConnection: Host=postgres;Port=5432;Database=erp_user;Username=erp_user;Password=postgres
      JWT__Secret: your-jwt-secret-key-here-make-it-long-and-secure
      JWT__Issuer: erp-system
      JWT__Audience: erp-clients
      Database__EnableSeeding: "true"
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  shop-service:
    image: ghcr.io/jctroth/erp-shop-service:latest
    container_name: erp-shop-service
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__DefaultConnection: Host=postgres;Port=5432;Database=erp_shop;Username=erp_shop;Password=postgres
      Database__EnableSeeding: "true"
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  accounting-service:
    image: ghcr.io/jctroth/erp-accounting-service:latest
    container_name: erp-accounting-service
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__DefaultConnection: Host=postgres;Port=5432;Database=erp_accounting;Username=erp_accounting;Password=postgres
      Database__EnableSeeding: "true"
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  masterdata-service:
    image: ghcr.io/jctroth/erp-masterdata-service:latest
    container_name: erp-masterdata-service
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__DefaultConnection: Host=postgres;Port=5432;Database=erp_masterdata;Username=erp_masterdata;Password=postgres
      Database__EnableSeeding: "true"
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  orders-service:
    image: ghcr.io/jctroth/erp-orders-service:latest
    container_name: erp-orders-service
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__DefaultConnection: Host=postgres;Port=5432;Database=erp_orders;Username=erp_orders;Password=postgres
      Database__EnableSeeding: "true"
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  # ==========================================================================
  # Java Services
  # ==========================================================================
  company-service:
    image: ghcr.io/jctroth/erp-company-service:latest
    container_name: erp-company-service
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/erp_company
      SPRING_DATASOURCE_USERNAME: erp_company
      SPRING_DATASOURCE_PASSWORD: postgres
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure

#  edifact-service:
#    image: ghcr.io/jctroth/erp-edifact-service:latest
#    container_name: erp-edifact-service
#    environment:
#      SPRING_PROFILES_ACTIVE: prod
#      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/erp_edifact
#      SPRING_DATASOURCE_USERNAME: erp_edifact
#      SPRING_DATASOURCE_PASSWORD: postgres
#    depends_on:
#      postgres:
#        condition: service_healthy
#    logging: *default-logging
#    networks:
#      - backend
#    deploy:
#      resources:
#        limits:
#          cpus: '1.0'
#          memory: 1G
#        reservations:
#          cpus: '0.5'
#          memory: 512M
#      restart_policy:
#        condition: on-failure

  notification-service:
    image: ghcr.io/jctroth/erp-notification-service:latest
    container_name: erp-notification-service
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/erp_notification
      SPRING_DATASOURCE_USERNAME: erp_notification
      SPRING_DATASOURCE_PASSWORD: postgres
      SMTP_HOST: smtp.example.com
      SMTP_PORT: 587
      SMTP_USERNAME: your-email@example.com
      SMTP_PASSWORD: your-smtp-password
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  translation-service:
    build:
      context: ./apps/services/java/translation-service
    image: ghcr.io/jctroth/erp-translation-service:latest
    container_name: erp-translation-service
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/erp_translation
      SPRING_DATASOURCE_USERNAME: erp_translation
      SPRING_DATASOURCE_PASSWORD: postgres
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  scripting-service:
    build:
      context: ./apps/services/java/scripting-service
    image: ghcr.io/jctroth/erp-scripting-service:latest
    container_name: erp-scripting-service
    profiles:
      - scripting  # Only start with: docker compose --profile scripting up
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/erp_scripting
      SPRING_DATASOURCE_USERNAME: erp_scripting
      SPRING_DATASOURCE_PASSWORD: postgres
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  # ==========================================================================
  # Node.js Services
  # ==========================================================================
  templates-service:
    image: ghcr.io/jctroth/erp-templates-service:latest
    container_name: erp-templates-service
    environment:
      NODE_ENV: production
      PORT: 3001
      DATABASE_URL: postgresql://erp_templates:postgres@postgres:5432/erp_templates
    depends_on:
      postgres:
        condition: service_healthy
    logging: *default-logging
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
      restart_policy:
        condition: on-failure

  # ==========================================================================
  # Gateway & Frontend
  # ==========================================================================
  gateway:
    image: ghcr.io/jctroth/erp-gateway:latest
    container_name: erp-gateway
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: production
      PORT: 4000
      JWT_SECRET: your-jwt-secret-key-here-make-it-long-and-secure
      USER_SERVICE_URL: http://user-service:5000/graphql
      SHOP_SERVICE_URL: http://shop-service:5003/graphql
      ACCOUNTING_SERVICE_URL: http://accounting-service:5002/graphql
      MASTERDATA_SERVICE_URL: http://masterdata-service:5001/graphql
      ORDERS_SERVICE_URL: http://orders-service:5004/graphql
      COMPANY_SERVICE_URL: http://company-service:8080/graphql
      TRANSLATION_SERVICE_URL: http://translation-service:8082/graphql
    logging: *default-logging
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure

  frontend:
    # image: ghcr.io/jctroth/erp-frontend:latest
    build:
      context: ./apps/frontend
    container_name: erp-frontend
    ports:
      - "3000:80"
    environment:
      VITE_API_URL: http://gateway:4000/graphql
      VITE_API_WS_URL: ws://gateway:4000/graphql
    logging: *default-logging
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
        reservations:
          cpus: '0.5'
          memory: 128M
      restart_policy:
        condition: on-failure

  # ==========================================================================
  # Nginx Reverse Proxy (commented out - using system nginx)
  # ==========================================================================
  # nginx:
  #   image: nginx:alpine
  #   container_name: erp-nginx
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./default.conf:/etc/nginx/conf.d/default.conf:ro
  #     - /etc/letsencrypt:/etc/letsencrypt:ro
  #   depends_on:
  #     - frontend
  #     - gateway
  #   logging: *default-logging
  #   networks:
  #     - backend
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.5'
  #         memory: 256M
  #       reservations:
  #         cpus: '0.25'
  #         memory: 128M
  #     restart_policy:
  #       condition: on-failure

volumes:
  postgres-data:

networks:
  backend:
    driver: bridge
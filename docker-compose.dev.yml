# Development Docker Compose
# For local development with hot-reload

services:
  # Frontend
  frontend:
    build:
      context: ./apps/frontend
      # use Dockerfile.dev (exists) for development build
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    volumes:
      - ./apps/frontend:/app
    environment:
      - VITE_GATEWAY_URL=http://gateway:4000
    depends_on:
      - gateway

  # Gateway
  gateway:
    build:
      context: ./apps/gateway
      dockerfile: Dockerfile.dev
    ports:
      - "4000:4000"
    volumes:
      - ./apps/gateway/src:/app/src
      - ./apps/gateway/supergraph-config.yaml:/app/supergraph-config.yaml
      - ./apps/gateway/supergraph.graphql:/app/supergraph.graphql
    environment:
      - NODE_ENV=development
      - DEBUG=apollo:gateway
      - USER_SERVICE_URL=http://user-service:5000/graphql
      - TRANSLATION_SERVICE_URL=http://translation-service:8081/graphql
      - COMPANY_SERVICE_URL=http://company-service:8080/graphql
      - SHOP_SERVICE_URL=http://shop-service:5003/graphql
      - ACCOUNTING_SERVICE_URL=http://accounting-service:5001/graphql
      - MASTERDATA_SERVICE_URL=http://masterdata-service:5002/graphql
    depends_on:
      - user-service
      - company-service
      - shop-service
      - translation-service
      - masterdata-service

  # .NET Services
  user-service:
    build:
      context: ./apps/services/dotnet/UserService
      # use default Dockerfile in UserService
    ports:
      - "5000:5000"
    volumes:
      - ./apps/services/dotnet/UserService:/app
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=postgres-users;Database=userdb;Username=postgres;Password=postgres
      - Jwt__Secret=your-super-secret-key-at-least-256-bits-long-for-hs256
    depends_on:
      - postgres-users

  shop-service:
    build:
      context: ./apps/services/dotnet/ShopService
      # use default Dockerfile in ShopService
    ports:
      - "5003:5003"
    volumes:
      - ./apps/services/dotnet/ShopService:/app
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=postgres-shop;Database=shopdb;Username=postgres;Password=postgres
    depends_on:
      - postgres-shop

  # accounting-service:
  #   build:
  #     context: ./apps/services/dotnet/AccountingService
  #     # use default Dockerfile in AccountingService
  #   ports:
  #     - "5001:5001"
  #   volumes:
  #     - ./apps/services/dotnet/AccountingService:/app
  #   environment:
  #     - ASPNETCORE_ENVIRONMENT=Development
  #     - ConnectionStrings__DefaultConnection=Host=postgres-accounting;Database=accountingdb;Username=postgres;Password=postgres
  #   depends_on:
  #     - postgres-accounting

  masterdata-service:
    build:
      context: ./apps/services/dotnet/MasterdataService
      target: development
      # use default Dockerfile in MasterdataService
    ports:
      - "5002:5002"
    volumes:
      - ./apps/services/dotnet/MasterdataService:/app
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=postgres-masterdata;Database=masterdatadb;Username=postgres;Password=postgres
    depends_on:
      - postgres-masterdata

  # Java Services
  company-service:
    build:
      context: ./apps/services/java/company-service
      # use default Dockerfile in company-service
    ports:
      - "8081:8080"
    volumes:
      - ./apps/services/java/company-service:/app
      - /app/.gradle
      - /app/build
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-company:5432/companydb
      - DB_HOST=postgres-company
      - DB_PORT=5432
      - DB_NAME=companydb
      - DB_USER=postgres
      - DB_PASSWORD=postgres
    depends_on:
      - postgres-company

  notification-service:
    build:
      context: ./apps/services/java/notification-service
      # use default Dockerfile in notification-service
    ports:
      - "8082:8082"
    volumes:
      - ./apps/services/java/notification-service:/app
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-notification:5432/notificationdb
      - DB_HOST=postgres-notification
      - DB_PORT=5432
      - DB_NAME=notificationdb
      - DB_USER=postgres
      - DB_PASSWORD=postgres
    depends_on:
      - postgres-notification

  translation-service:
    build:
      context: ./apps/services/java/translation-service
      # use default Dockerfile in translation-service
    ports:
      - "8083:8081"
    volumes:
      - ./apps/services/java/translation-service:/app
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-translation:5432/translationdb
      - DB_HOST=postgres-translation
      - DB_PORT=5432
      - DB_NAME=translationdb
      - DB_USER=postgres
      - DB_PASSWORD=postgres
    depends_on:
      - postgres-translation

  scripting-service:
    build:
      context: ./apps/services/java/scripting-service
      # use default Dockerfile in scripting-service
    ports:
      - "8084:8084"
    volumes:
      - ./apps/services/java/scripting-service:/app
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - DB_HOST=postgres-company
      - DB_PORT=5432
      - DB_NAME=companydb
      - DB_USER=postgres
      - DB_PASSWORD=postgres
    depends_on:
      - postgres-company

  edifact-service:
    build:
      context: ./apps/services/java/edifact-service
      # use default Dockerfile in edifact-service
    ports:
      - "8085:8085"
    volumes:
      - ./apps/services/java/edifact-service:/app
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - DB_HOST=postgres-company
      - DB_PORT=5432
      - DB_NAME=companydb
      - DB_USER=postgres
      - DB_PASSWORD=postgres
    depends_on:
      - postgres-company

  # PostgreSQL Databases
  postgres-users:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: userdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    # changed host port to avoid conflict with local Postgres on 5432
    ports:
      - "5442:5432"
    volumes:
      - postgres-users-data:/var/lib/postgresql/data

  postgres-shop:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: shopdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5436:5432"
    volumes:
      - postgres-shop-data:/var/lib/postgresql/data

  postgres-accounting:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: accountingdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5437:5432"
    volumes:
      - postgres-accounting-data:/var/lib/postgresql/data

  postgres-masterdata:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: masterdatadb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5438:5432"
    volumes:
      - postgres-masterdata-data:/var/lib/postgresql/data

  postgres-company:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: companydb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"
    volumes:
      - postgres-company-data:/var/lib/postgresql/data

  postgres-notification:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: notificationdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5434:5432"
    volumes:
      - postgres-notification-data:/var/lib/postgresql/data

  postgres-translation:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: translationdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5435:5432"
    volumes:
      - postgres-translation-data:/var/lib/postgresql/data

  # Observability
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./infrastructure/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./infrastructure/grafana/provisioning:/etc/grafana/provisioning
      - grafana-data:/var/lib/grafana

  # Message Queue (for notifications)
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

volumes:
  postgres-users-data:
  postgres-shop-data:
  postgres-accounting-data:
  postgres-masterdata-data:
  postgres-company-data:
  postgres-notification-data:
  postgres-translation-data:
  prometheus-data:
  grafana-data:
  redis-data:

networks:
  default:
    name: erp-network

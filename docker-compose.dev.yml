# Development Docker Compose
# For local development with hot-reload

services:
  # Frontend
  frontend:
    build:
      context: ./apps/frontend
      # use Dockerfile.dev (exists) for development build
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    volumes:
      - ./apps/frontend/src:/app/src
      - ./apps/frontend/public:/app/public
      - ./apps/frontend/index.html:/app/index.html
      - ./apps/frontend/vite.config.ts:/app/vite.config.ts
      - ./apps/frontend/tsconfig.json:/app/tsconfig.json
      - ./apps/frontend/tsconfig.node.json:/app/tsconfig.node.json
      - ./apps/frontend/package.json:/app/package.json
      - ./apps/frontend/package-lock.json:/app/package-lock.json
      - ./apps/frontend/postcss.config.js:/app/postcss.config.js
      - ./apps/frontend/tailwind.config.js:/app/tailwind.config.js
      - ./apps/frontend/vitest.config.ts:/app/vitest.config.ts
      - ./apps/frontend/vite.config.d.ts:/app/vite.config.d.ts
      - /app/node_modules
    environment:
      - VITE_GATEWAY_URL=http://gateway:4000
      - VITE_NOTIFICATION_URL=http://notification-service:8082
      - VITE_BASE_URL=http://localhost
    depends_on:
      - gateway

  # Gateway
  gateway:
    build:
      context: ./apps/gateway
      dockerfile: Dockerfile.dev
    ports:
      - "4000:4000"
    volumes:
      - ./apps/gateway/src:/app/src
      - ./apps/gateway/supergraph-config.yaml:/app/supergraph-config.yaml
      - ./apps/gateway/supergraph.graphql:/app/supergraph.graphql
    environment:
      - NODE_ENV=development
      - DEBUG=apollo:gateway
      - USER_SERVICE_URL=http://user-service:5000/graphql/
      - TRANSLATION_SERVICE_URL=http://translation-service:8081/graphql
      - COMPANY_SERVICE_URL=http://company-service:8080/graphql
      - SHOP_SERVICE_URL=http://shop-service:5003/graphql/
      - ACCOUNTING_SERVICE_URL=http://accounting-service:5001/graphql/
      - MASTERDATA_SERVICE_URL=http://masterdata-service:5002/graphql/
      - ORDERS_SERVICE_URL=http://orders-service:5004/graphql/
    depends_on:
      - user-service
      - company-service
      - translation-service
      - accounting-service
      - masterdata-service
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # .NET Services
  user-service:
    image: mcr.microsoft.com/dotnet/sdk:8.0-alpine
    ports:
      - "5000:5000"
    volumes:
      - ./apps/services/dotnet/UserService:/app
    working_dir: /app
    command: dotnet run --urls http://0.0.0.0:5000
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=erp_user;Username=erp_user;Password=postgres
      - Jwt__Key=your-super-secret-key-at-least-256-bits-long-for-hs256
      - Jwt__Issuer=ERP_System
      - Jwt__Audience=ERP_System
    depends_on:
      - postgres

  shop-service:
    image: mcr.microsoft.com/dotnet/sdk:8.0-alpine
    ports:
      - "5003:5003"
    volumes:
      - ./apps/services/dotnet/ShopService:/app
    working_dir: /app
    command: dotnet run --urls http://0.0.0.0:5003
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=erp_shop;Username=erp_shop;Password=postgres
      - Jwt__Key=your-super-secret-key-at-least-256-bits-long-for-hs256
      - Jwt__Issuer=ERP_System
      - Jwt__Audience=ERP_System
    depends_on:
      - postgres

  accounting-service:
    build:
      context: ./apps/services/dotnet/AccountingService
      target: development
    ports:
      - "5001:5001"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=erp_accounting;Username=erp_accounting;Password=postgres
      - Jwt__Key=your-super-secret-key-at-least-256-bits-long-for-hs256
      - Jwt__Issuer=ERP_System
      - Jwt__Audience=ERP_System
    depends_on:
      - postgres

  masterdata-service:
    image: mcr.microsoft.com/dotnet/sdk:8.0-alpine
    ports:
      - "5002:5002"
    volumes:
      - ./apps/services/dotnet/MasterdataService:/app
    working_dir: /app
    command: dotnet run --urls http://0.0.0.0:5002
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=erp_masterdata;Username=erp_masterdata;Password=postgres
      - Jwt__Key=your-super-secret-key-at-least-256-bits-long-for-hs256
      - Jwt__Issuer=ERP_System
      - Jwt__Audience=ERP_System
    depends_on:
      - postgres

  orders-service:
    image: mcr.microsoft.com/dotnet/sdk:8.0-alpine
    ports:
      - "5004:5004"
    volumes:
      - ./apps/services/dotnet/OrdersService:/app
    working_dir: /app
    command: dotnet run --urls http://0.0.0.0:5004
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=erp_orders;Username=erp_orders;Password=postgres
      - Jwt__Key=your-super-secret-key-at-least-256-bits-long-for-hs256
      - Jwt__Issuer=ERP_System
      - Jwt__Audience=ERP_System
    depends_on:
      - postgres

  # Java Services
  company-service:
    build:
      context: ./apps/services/java/company-service
      # use default Dockerfile in company-service
    ports:
      - "8080:8080"
    volumes:
      - ./apps/services/java/company-service:/app
      - /app/.gradle
      - /app/build
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/companydb
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=companydb
      - DB_USER=erp_company
      - DB_PASSWORD=postgres
    depends_on:
      - postgres

  notification-service:
    build:
      context: ./apps/services/java/notification-service
      # use default Dockerfile in notification-service
    ports:
      - "8082:8082"
    volumes:
      - ./apps/services/java/notification-service:/app
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/notificationdb
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=notificationdb
      - DB_USER=erp_notification
      - DB_PASSWORD=postgres
    depends_on:
      - postgres

  # Build from source with compatible dependencies
  translation-service:
    build:
      context: ./apps/services/java/translation-service
      dockerfile: Dockerfile.build
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_CACHE_TYPE=none
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/translationdb
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=translationdb
      - DB_USER=erp_translation
      - DB_PASSWORD=postgres
    depends_on:
      - postgres
    networks:
      - default
    restart: unless-stopped

  # scripting-service:
  #   build:
  #     context: ./apps/services/java/scripting-service
  #     # use default Dockerfile in scripting-service
  #   profiles:
  #     - scripting  # Only start with: docker compose --profile scripting up
  #   ports:
  #     - "8084:8084"
  #   volumes:
  #     - ./apps/services/java/scripting-service:/app
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=dev
  #     - DB_HOST=postgres
  #     - DB_PORT=5432
  #     - DB_NAME=companydb
  #     - DB_USER=erp_company
  #     - DB_PASSWORD=postgres
  #   depends_on:
  #     - postgres

  # edifact-service:
  #   build:
  #     context: ./apps/services/java/edifact-service
  #     # use default Dockerfile in edifact-service
  #   ports:
  #     - "8085:8085"
  #   volumes:
  #     - ./apps/services/java/edifact-service:/app
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=dev
  #     - DB_HOST=postgres
  #     - DB_PORT=5432
  #     - DB_NAME=companydb
  #     - DB_USER=erp_company
  #     - DB_PASSWORD=postgres
  #   depends_on:
  #     - postgres

  templates-service:
    build:
      context: ./apps/services/nodejs/templates-service
    ports:
      - "8087:8087"
    volumes:
      - ./apps/services/nodejs/templates-service:/app
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://erp_templates:postgres@postgres:5432/templatesdb
    depends_on:
      - postgres

  # PostgreSQL Database (consolidated single instance)
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      # Passwords for per-service users (defaults for development)
      ERP_USER_PASSWORD: postgres
      ERP_SHOP_PASSWORD: postgres
      ERP_ACCOUNTING_PASSWORD: postgres
      ERP_MASTERDATA_PASSWORD: postgres
      ERP_ORDERS_PASSWORD: postgres
      ERP_COMPANY_PASSWORD: postgres
      ERP_NOTIFICATION_PASSWORD: postgres
      ERP_TRANSLATION_PASSWORD: postgres
      ERP_TEMPLATES_PASSWORD: postgres
      ERP_EDIFACT_PASSWORD: postgres
      ERP_SCRIPTING_PASSWORD: postgres
    ports:
      - "15432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./infrastructure/postgres-init:/docker-entrypoint-initdb.d:ro

  # MinIO (S3-compatible storage for documents)
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      MINIO_PROMETHEUS_AUTH_TYPE: public
      MINIO_BROWSER: "on"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Observability
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./infrastructure/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./infrastructure/grafana/provisioning:/etc/grafana/provisioning
      - grafana-data:/var/lib/grafana

volumes:
  postgres-data:
  minio-data:
  prometheus-data:
  grafana-data:

networks:
  default:
    name: erp-network

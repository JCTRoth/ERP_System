import React, { createContext, useContext, useCallback, useEffect, useState } from 'react';
import { useQuery, gql } from '@apollo/client';
import { useAuthStore } from '../stores/authStore';

const GET_TRANSLATIONS = gql`
  query GetTranslations($language: String!, $companyId: ID) {
    translations(language: $language, companyId: $companyId) {
      key
      value
    }
  }
`;

type Language = 'en' | 'de' | 'fr' | 'ru';

interface I18nContextType {
  t: (key: string, params?: Record<string, string | number>) => string;
  language: Language;
  setLanguage: (lang: Language) => void;
  isLoading: boolean;
}

const I18nContext = createContext<I18nContextType | null>(null);

const SUPPORTED_LANGUAGES: Language[] = ['en', 'de', 'fr', 'ru'];

const LANGUAGE_NAMES: Record<Language, string> = {
  en: 'English',
  de: 'Deutsch',
  fr: 'Français',
  ru: 'Русский',
};

const FALLBACK_TRANSLATIONS: Record<Language, Record<string, string>> = {
  en: {
    'nav.dashboard': 'Dashboard',
    'nav.companies': 'Companies',
    'nav.users': 'Users',
    'nav.products': 'Products',
    'nav.orders': 'Orders',
    'nav.accounting': 'Accounting',
    'nav.masterdata': 'Master Data',
    'nav.translations': 'Translations',
    'nav.uiBuilder': 'UI Builder',
    'nav.settings': 'Settings',
    'dashboard.welcome': 'Welcome back, {name}!',
    'dashboard.overview': 'Overview',
    'dashboard.totalCompanies': 'Total Companies',
    'dashboard.totalUsers': 'Total Users',
    'dashboard.revenue': 'Revenue',
    'dashboard.growth': 'Growth',
    'dashboard.recentUsers': 'Recent Users',
    'dashboard.noRecentActivity': 'No recent activity',
    'dashboard.recentOrders': 'Recent Orders',
    'auth.signIn': 'Sign In',
    'auth.email': 'Email',
    'auth.password': 'Password',
    'auth.forgotPassword': 'Forgot Password?',
    'auth.demoCredentials': 'Demo Credentials:',
    'auth.backToLogin': 'Back to Login',
    'auth.confirmPassword': 'Confirm Password',
    'auth.forgotPasswordDescription': 'Enter your email address and we\'ll send you a link to reset your password.',
    'auth.loginError': 'Login failed. Please check your credentials.',
    'auth.newPassword': 'New Password',
    'auth.passwordResetSuccess': 'Password reset successful',
    'auth.passwordResetSuccessDescription': 'Your password has been reset successfully. You can now sign in with your new password.',
    'auth.passwordsDoNotMatch': 'Passwords do not match',
    'auth.passwordTooShort': 'Password must be at least 8 characters',
    'auth.resetEmailSent': 'Reset email sent',
    'auth.resetEmailSentDescription': 'If an account with that email exists, we\'ve sent you a password reset link.',
    'auth.resetError': 'Failed to send reset email',
    'auth.resetPassword': 'Reset Password',
    'auth.resetPasswordDescription': 'Enter your new password below.',
    'auth.sendResetLink': 'Send Reset Link',
    'settings.title': 'Settings',
    'settings.subtitle': 'Manage your account and application preferences',
    'settings.appearance': 'Appearance',
    'settings.theme': 'Theme',
    'settings.language': 'Language',
    'settings.developer': 'Developer',
    'settings.showTranslationKeys': 'Show Translation Keys',
    'settings.showTranslationKeysDesc': 'Display translation keys instead of translated text for debugging',
    'settings.account': 'Account',
    'users.email': 'Email',
    'users.firstName': 'First Name',
    'users.lastName': 'Last Name',
    'users.editUser': 'Edit User',
    'users.addUser': 'Add User',
    'users.password': 'Password',
    'users.passwordPlaceholder': 'Leave empty to keep current password',
    'users.language': 'Language',
    'users.title': 'Users',
    'users.subtitle': 'Manage system users and their permissions',
    'users.user': 'User',
    'users.confirmDelete': 'Are you sure you want to delete this user?',
    'users.noUsers': 'No users found',
    'uiBuilder.selectComponent': 'Select a component to edit its properties',
    'uiBuilder.properties': 'Properties',
    'uiBuilder.componentType': 'Component Type',
    'uiBuilder.content': 'Content',
    'uiBuilder.variant': 'Variant',
    'uiBuilder.level': 'Level',
    'uiBuilder.label': 'Label',
    'uiBuilder.placeholder': 'Placeholder',
    'uiBuilder.inputType': 'Input Type',
    'uiBuilder.height': 'Height',
    'uiBuilder.imageUrl': 'Image URL',
    'uiBuilder.altText': 'Alt Text',
    'uiBuilder.title': 'Title',
    'uiBuilder.noProperties': 'No properties available for this component',
    'uiBuilder.emptyCanvas': 'Empty Canvas',
    'uiBuilder.dragComponents': 'Drag components here',
    'uiBuilder.components': 'Components',
    'uiBuilder.basicComponents': 'Basic Components',
    'uiBuilder.formComponents': 'Form Components',
    'uiBuilder.layoutComponents': 'Layout Components',
    'uiBuilder.dataComponents': 'Data Components',
    'uiBuilder.unsaved': 'Unsaved',
    'uiBuilder.confirmDeletePage': 'Are you sure you want to delete this page?',
    'uiBuilder.createNewPage': 'Create New Page',
    'uiBuilder.createPage': 'Create Page',
    'uiBuilder.current': 'Current',
    'uiBuilder.download': 'Download',
    'uiBuilder.exportCode': 'Export Code',
    'uiBuilder.exportCodeDescription': 'Download the generated React code for this page',
    'uiBuilder.import': 'Import',
    'uiBuilder.importError': 'Failed to import page. Please check the file format.',
    'uiBuilder.managePages': 'Manage Pages',
    'uiBuilder.managePagesDescription': 'Create, edit, and organize your application pages',
    'uiBuilder.noComponents': 'No components available',
    'uiBuilder.noPages': 'No pages found',
    'uiBuilder.pageName': 'Page Name',
    'uiBuilder.pageNamePlaceholder': 'Enter page name...',
    'uiBuilder.pages': 'Pages',
    'uiBuilder.pageSlug': 'Page Slug',
    'uiBuilder.pageSlugPlaceholder': 'page-slug',
    'uiBuilder.preview': 'Preview',
    'uiBuilder.previewDescription': 'Preview how your page will look',
    'uiBuilder.save': 'Save',
    'uiBuilder.subtitle': 'Design and build user interfaces with drag-and-drop components',
    'uiBuilder.untitled': 'Untitled',
    'uiBuilder.updated': 'Updated',
    'common.logout': 'Logout',
    'common.active': 'Active',
    'common.cancel': 'Cancel',
    'common.saving': 'Saving...',
    'common.save': 'Save',
    'common.all': 'All',
    'common.inactive': 'Inactive',
    'common.createdAt': 'Created At',
    'common.status': 'Status',
    'common.actions': 'Actions',
    'common.date': 'Date',
    'common.description': 'Description',
    'common.add': 'Add',
    'common.allStatuses': 'All Statuses',
    'common.backToHome': 'Back to Home',
    'common.close': 'Close',
    'common.copy': 'Copy',
    'common.delete': 'Delete',
    'common.duplicate': 'Duplicate',
    'common.edit': 'Edit',
    'common.loading': 'Loading...',
    'common.of': 'of',
    'common.select': 'Select',
    'common.view': 'View',
    'products.product': 'Product',
    'products.sku': 'SKU',
    'products.category': 'Category',
    'products.price': 'Price',
    'products.stock': 'Stock',
    'products.title': 'Products',
    'products.subtitle': 'Manage your product catalog',
    'products.addProduct': 'Add Product',
    'products.brand': 'Brand',
    'products.compareAtPrice': 'Compare at Price',
    'products.confirmDelete': 'Are you sure you want to delete this product?',
    'products.costPrice': 'Cost Price',
    'products.isActive': 'Is Active',
    'products.name': 'Name',
    'products.noProducts': 'No products found',
    'products.products': 'Products',
    'products.quantity': 'Quantity',
    'products.searchPlaceholder': 'Search products...',
    'companies.name': 'Name',
    'companies.slug': 'Slug',
    'companies.addCompany': 'Add Company',
    'companies.editCompany': 'Edit Company',
    'companies.title': 'Companies',
    'companies.subtitle': 'Manage your company information and settings',
    'companies.confirmDelete': 'Are you sure you want to delete this company?',
    'companies.noCompanies': 'No companies found',
    'orders.orderNumber': 'Order Number',
    'orders.customer': 'Customer',
    'orders.items': 'Items',
    'orders.total': 'Total',
    'orders.createOrder': 'Create Order',
    'orders.addFirstItem': 'Add your first item',
    'orders.addItem': 'Add Item',
    'orders.addItemsRequired': 'At least one item is required',
    'orders.allStatuses': 'All Statuses',
    'orders.billingAddress': 'Billing Address',
    'orders.cancel': 'Cancel',
    'orders.changeStatus': 'Change Status',
    'orders.confirmCancel': 'Are you sure you want to cancel this order?',
    'orders.created': 'Created',
    'orders.customerInfo': 'Customer Information',
    'orders.discount': 'Discount',
    'orders.guestOrder': 'Guest Order',
    'orders.noItemsYet': 'No items yet',
    'orders.noOrders': 'No orders found',
    'orders.notes': 'Notes',
    'orders.notesPlaceholder': 'Add any special instructions...',
    'orders.orderDetails': 'Order Details',
    'orders.orderInfo': 'Order Information',
    'orders.orderNotFound': 'Order not found',
    'orders.orders': 'Orders',
    'orders.product': 'Product',
    'orders.qty': 'Qty',
    'orders.searchPlaceholder': 'Search orders...',
    'orders.selectProduct': 'Select Product',
    'orders.shipping': 'Shipping',
    'orders.shippingAddress': 'Shipping Address',
    'orders.status.cancelled': 'Cancelled',
    'orders.status.confirmed': 'Confirmed',
    'orders.status.delivered': 'Delivered',
    'orders.status.pending': 'Pending',
    'orders.status.processing': 'Processing',
    'orders.status.shipped': 'Shipped',
    'orders.subtitle': 'Manage customer orders and fulfillment',
    'orders.subtotal': 'Subtotal',
    'orders.tax': 'Tax',
    'orders.title': 'Orders',
    'orders.unitPrice': 'Unit Price',
    'orders.updated': 'Updated',
    'orders.viewDetails': 'View Details',
    'accounting.title': 'Accounting',
    'accounting.subtitle': 'Manage invoices, payments, and financial records',
    'accounting.invoiceNumber': 'Invoice Number',
    'accounting.customer': 'Customer',
    'accounting.type': 'Type',
    'accounting.invoiceDate': 'Invoice Date',
    'accounting.dueDate': 'Due Date',
    'accounting.total': 'Total',
    'accounting.balance': 'Balance',
    'accounting.accountingSummary': 'Accounting Summary',
    'accounting.accounts': 'Accounts',
    'accounting.accountType.asset': 'Asset',
    'accounting.accountType.equity': 'Equity',
    'accounting.accountType.expense': 'Expense',
    'accounting.accountType.liability': 'Liability',
    'accounting.accountType.revenue': 'Revenue',
    'accounting.addAccount': 'Add Account',
    'accounting.addLine': 'Add Line',
    'accounting.allAccountTypes': 'All Account Types',
    'accounting.allStatuses': 'All Statuses',
    'accounting.allTypes': 'All Types',
    'accounting.asOfDate': 'As of Date',
    'accounting.assets': 'Assets',
    'accounting.balanced': 'Balanced',
    'accounting.createInvoice': 'Create Invoice',
    'accounting.createJournalEntry': 'Create Journal Entry',
    'accounting.creditNote': 'Credit Note',
    'accounting.currency': 'Currency',
    'accounting.currentAssets': 'Current Assets',
    'accounting.currentLiabilities': 'Current Liabilities',
    'accounting.debitNote': 'Debit Note',
    'accounting.entries': 'Entries',
    'accounting.entryType.adjusting': 'Adjusting',
    'accounting.entryType.closing': 'Closing',
    'accounting.entryType.recurring': 'Recurring',
    'accounting.entryType.reversing': 'Reversing',
    'accounting.entryType.standard': 'Standard',
    'accounting.equity': 'Equity',
    'accounting.expenses': 'Expenses',
    'accounting.exportPdf': 'Export PDF',
    'accounting.lineItems': 'Line Items',
    'accounting.netIncome': 'Net Income',
    'accounting.noInvoices': 'No invoices found',
    'accounting.noJournalEntries': 'No journal entries found',
    'accounting.nonCurrentAssets': 'Non-Current Assets',
    'accounting.notes': 'Notes',
    'accounting.period': 'Period',
    'accounting.post': 'Post',
    'accounting.price': 'Price',
    'accounting.purchaseInvoice': 'Purchase Invoice',
    'accounting.qty': 'Qty',
    'accounting.reportComingSoon': 'Report coming soon',
    'accounting.reports.incomeStatement': 'Income Statement',
    'accounting.retainedEarnings': 'Retained Earnings',
    'accounting.revenue': 'Revenue',
    'accounting.salesInvoice': 'Sales Invoice',
    'accounting.selectAccount': 'Select Account',
    'accounting.status.draft': 'Draft',
    'accounting.status.overdue': 'Overdue',
    'accounting.status.paid': 'Paid',
    'accounting.status.partial': 'Partial',
    'accounting.status.pending': 'Pending',
    'accounting.status.posted': 'Posted',
    'accounting.status.reversed': 'Reversed',
    'accounting.status.sent': 'Sent',
    'accounting.subtotal': 'Subtotal',
    'accounting.tax': 'Tax',
    'translations.key': 'Key',
    'translations.namespace': 'Namespace',
    'translations.english': 'English',
    'translations.german': 'German',
    'translations.french': 'French',
    'translations.russian': 'Russian',
    'translations.noTranslations': 'No translations found',
    'translations.missingTranslations': 'Missing translations',
    'translations.title': 'Translations',
    'translations.subtitle': 'Manage application translations and localization',
    'translations.addKey': 'Add Key',
    'translations.allNamespaces': 'All Namespaces',
    'translations.export': 'Export',
    'translations.missing': 'Missing',
    'translations.searchPlaceholder': 'Search translations...',
    'translations.values': 'Values',
    'errors.pageNotFound': 'Page Not Found',
    'errors.pageNotFoundDesc': 'The page you are looking for does not exist.',
    'masterdata.customerNumber': 'Customer Number',
    'masterdata.activeAssets': 'Active Assets',
    'masterdata.addAsset': 'Add Asset',
    'masterdata.addCustomer': 'Add Customer',
    'masterdata.addDepartment': 'Add Department',
    'masterdata.addSupplier': 'Add Supplier',
    'masterdata.allDepartments': 'All Departments',
    'masterdata.allTypes': 'All Types',
    'masterdata.asset': 'Asset',
    'masterdata.assetType.building': 'Building',
    'masterdata.assetType.furniture': 'Furniture',
    'masterdata.assetType.it_equipment': 'IT Equipment',
    'masterdata.assetType.land': 'Land',
    'masterdata.assetType.machinery': 'Machinery',
    'masterdata.assetType.vehicle': 'Vehicle',
    'masterdata.assignedTo': 'Assigned To',
    'masterdata.baseUnit': 'Base Unit',
    'masterdata.blocked': 'Blocked',
    'masterdata.code': 'Code',
    'masterdata.confirmDelete': 'Are you sure you want to delete this item?',
    'masterdata.conversionFactor': 'Conversion Factor',
    'masterdata.currency': 'Currency',
    'masterdata.customerType.company': 'Company',
    'masterdata.customerType.government': 'Government',
    'masterdata.customerType.individual': 'Individual',
    'masterdata.customerType.non_profit': 'Non-Profit',
    'masterdata.days': 'Days',
    'masterdata.default': 'Default',
    'masterdata.department': 'Department',
    'masterdata.departments': 'Departments',
    'masterdata.discount': 'Discount',
    'masterdata.disposed': 'Disposed',
    'masterdata.email': 'Email',
    'masterdata.employee': 'Employee',
    'masterdata.employeeNumber': 'Employee Number',
    'masterdata.employees': 'Employees',
    'masterdata.exchangeRate': 'Exchange Rate',
    'masterdata.hireDate': 'Hire Date',
    'masterdata.jobTitle': 'Job Title',
    'masterdata.legalName': 'Legal Name',
    'masterdata.location': 'Location',
    'masterdata.maintenance': 'Maintenance',
    'masterdata.manager': 'Manager',
    'masterdata.netDays': 'Net Days',
    'masterdata.noAssets': 'No assets found',
    'masterdata.noCustomers': 'No customers found',
    'masterdata.noDepartments': 'No departments found',
    'masterdata.noEmployees': 'No employees found',
    'masterdata.noSuppliers': 'No suppliers found',
    'masterdata.notes': 'Notes',
    'masterdata.onHold': 'On Hold',
    'masterdata.onLeave': 'On Leave',
    'masterdata.paymentTerms': 'Payment Terms',
    'masterdata.pendingApproval': 'Pending Approval',
    'masterdata.phone': 'Phone',
    'masterdata.probation': 'Probation',
    'masterdata.purchased': 'Purchased',
    'masterdata.rating': 'Rating',
    'masterdata.searchAssets': 'Search assets...',
    'masterdata.searchCustomers': 'Search customers...',
    'masterdata.searchEmployees': 'Search employees...',
    'masterdata.searchSuppliers': 'Search suppliers...',
    'masterdata.supplierNumber': 'Supplier Number',
    'masterdata.suspended': 'Suspended',
    'masterdata.symbol': 'Symbol',
    'masterdata.taxId': 'Tax ID',
    'masterdata.terminated': 'Terminated',
    'masterdata.totalAssets': 'Total Assets',
    'masterdata.totalValue': 'Total Value',
    'masterdata.unassigned': 'Unassigned',
    'masterdata.value': 'Value',
    'masterdata.website': 'Website',
    'masterdata.name': 'Name',
    'masterdata.type': 'Type',
    'masterdata.contact': 'Contact',
    'masterdata.creditLimit': 'Credit Limit',
    'masterdata.title': 'Master Data',
    'masterdata.subtitle': 'Manage master data entities and relationships',
    'accounting.description': 'Description',
    'accounting.entryNumber': 'Entry Number',
    'accounting.debit': 'Debit',
    'accounting.credit': 'Credit',
  },
  de: {
    'nav.dashboard': 'Dashboard',
    'nav.companies': 'Firmen',
    'nav.users': 'Benutzer',
    'nav.products': 'Produkte',
    'nav.orders': 'Bestellungen',
    'nav.accounting': 'Buchhaltung',
    'nav.masterdata': 'Stammdaten',
    'nav.translations': 'Übersetzungen',
    'nav.uiBuilder': 'UI Builder',
    'nav.settings': 'Einstellungen',
    'dashboard.welcome': 'Willkommen zurück, {name}!',
    'dashboard.overview': 'Übersicht',
    'dashboard.totalCompanies': 'Anzahl Firmen',
    'dashboard.totalUsers': 'Anzahl Benutzer',
    'dashboard.revenue': 'Umsatz',
    'dashboard.growth': 'Wachstum',
    'dashboard.recentUsers': 'Neue Benutzer',
    'dashboard.noRecentActivity': 'Keine aktuellen Aktivitäten',
    'dashboard.recentOrders': 'Neue Bestellungen',
    'auth.signIn': 'Anmelden',
    'auth.email': 'E-Mail',
    'auth.password': 'Passwort',
    'auth.forgotPassword': 'Passwort vergessen?',
    'auth.demoCredentials': 'Demo Zugangsdaten:',
    'settings.title': 'Einstellungen',
    'settings.subtitle': 'Verwalten Sie Ihr Konto und Anwendungseinstellungen',
    'settings.appearance': 'Erscheinungsbild',
    'settings.theme': 'Thema',
    'settings.language': 'Sprache',
    'settings.developer': 'Entwickler',
    'settings.showTranslationKeys': 'Übersetzungsschlüssel anzeigen',
    'settings.showTranslationKeysDesc': 'Übersetzungsschlüssel anstelle von übersetztem Text zur Fehlerbehebung anzeigen',
    'settings.account': 'Konto',
    'users.email': 'E-Mail',
    'users.firstName': 'Vorname',
    'users.lastName': 'Nachname',
    'users.editUser': 'Benutzer bearbeiten',
    'users.addUser': 'Benutzer hinzufügen',
    'users.password': 'Passwort',
    'users.passwordPlaceholder': 'Leer lassen, um das aktuelle Passwort beizubehalten',
    'users.language': 'Sprache',
    'users.title': 'Benutzer',
    'users.subtitle': 'Verwalten Sie Systembenutzer und deren Berechtigungen',
    'users.user': 'Benutzer',
    'uiBuilder.selectComponent': 'Wählen Sie eine Komponente aus, um deren Eigenschaften zu bearbeiten',
    'uiBuilder.properties': 'Eigenschaften',
    'uiBuilder.componentType': 'Komponententyp',
    'uiBuilder.content': 'Inhalt',
    'uiBuilder.variant': 'Variante',
    'uiBuilder.level': 'Ebene',
    'uiBuilder.label': 'Beschriftung',
    'uiBuilder.placeholder': 'Platzhalter',
    'uiBuilder.inputType': 'Eingabetyp',
    'uiBuilder.height': 'Höhe',
    'uiBuilder.imageUrl': 'Bild-URL',
    'uiBuilder.altText': 'Alternativtext',
    'uiBuilder.title': 'Titel',
    'uiBuilder.noProperties': 'Keine Eigenschaften für diese Komponente verfügbar',
    'uiBuilder.emptyCanvas': 'Leere Leinwand',
    'uiBuilder.dragComponents': 'Komponenten hierher ziehen',
    'uiBuilder.components': 'Komponenten',
    'uiBuilder.basicComponents': 'Grundkomponenten',
    'uiBuilder.formComponents': 'Formularkomponenten',
    'uiBuilder.layoutComponents': 'Layoutkomponenten',
    'uiBuilder.dataComponents': 'Datenkomponenten',
    'uiBuilder.unsaved': 'Nicht gespeichert',
    'common.logout': 'Abmelden',
    'common.active': 'Aktiv',
    'common.cancel': 'Abbrechen',
    'common.saving': 'Speichern...',
    'common.save': 'Speichern',
    'common.all': 'Alle',
    'common.inactive': 'Inaktiv',
    'common.createdAt': 'Erstellt am',
    'common.status': 'Status',
    'common.actions': 'Aktionen',
    'common.date': 'Datum',
    'common.description': 'Beschreibung',
    'products.product': 'Produkt',
    'products.sku': 'SKU',
    'products.category': 'Kategorie',
    'products.price': 'Preis',
    'products.stock': 'Lager',
    'products.title': 'Produkte',
    'products.subtitle': 'Verwalten Sie Ihren Produktkatalog',
    'products.addProduct': 'Produkt hinzufügen',
    'companies.name': 'Name',
    'companies.slug': 'Slug',
    'companies.addCompany': 'Firma hinzufügen',
    'companies.editCompany': 'Firma bearbeiten',
    'companies.title': 'Firmen',
    'companies.subtitle': 'Verwalten Sie Ihre Firmeninformationen und -einstellungen',
    'orders.orderNumber': 'Bestellnummer',
    'orders.customer': 'Kunde',
    'orders.items': 'Artikel',
    'orders.total': 'Gesamt',
    'orders.createOrder': 'Bestellung erstellen',
    'accounting.title': 'Buchhaltung',
    'accounting.subtitle': 'Verwalten Sie Rechnungen, Zahlungen und Finanzunterlagen',
    'accounting.invoiceNumber': 'Rechnungsnummer',
    'accounting.customer': 'Kunde',
    'accounting.type': 'Typ',
    'accounting.invoiceDate': 'Rechnungsdatum',
    'accounting.dueDate': 'Fälligkeitsdatum',
    'accounting.total': 'Gesamt',
    'accounting.balance': 'Saldo',
    'accounting.accountingSummary': 'Buchhaltungsübersicht',
    'accounting.accounts': 'Konten',
    'accounting.accountType.asset': 'Aktiva',
    'accounting.accountType.equity': 'Eigenkapital',
    'accounting.accountType.expense': 'Aufwand',
    'accounting.accountType.liability': 'Passiva',
    'accounting.accountType.revenue': 'Ertrag',
    'accounting.addAccount': 'Konto hinzufügen',
    'accounting.addLine': 'Zeile hinzufügen',
    'accounting.allAccountTypes': 'Alle Kontotypen',
    'accounting.allStatuses': 'Alle Status',
    'accounting.allTypes': 'Alle Typen',
    'accounting.asOfDate': 'Stichtag',
    'accounting.assets': 'Aktiva',
    'accounting.balanced': 'Ausgeglichen',
    'accounting.createInvoice': 'Rechnung erstellen',
    'accounting.createJournalEntry': 'Buchung erstellen',
    'accounting.creditNote': 'Gutschrift',
    'accounting.currency': 'Währung',
    'accounting.currentAssets': 'Umlaufvermögen',
    'accounting.currentLiabilities': 'Kurzfristige Verbindlichkeiten',
    'accounting.debitNote': 'Lastschrift',
    'accounting.entries': 'Einträge',
    'accounting.entryType.adjusting': 'Berichtigung',
    'accounting.entryType.closing': 'Abschluss',
    'accounting.entryType.recurring': 'Wiederkehrend',
    'accounting.entryType.reversing': 'Stornierung',
    'accounting.entryType.standard': 'Standard',
    'accounting.equity': 'Eigenkapital',
    'accounting.expenses': 'Aufwendungen',
    'accounting.exportPdf': 'PDF exportieren',
    'accounting.lineItems': 'Positionen',
    'accounting.netIncome': 'Nettogewinn',
    'accounting.noInvoices': 'Keine Rechnungen gefunden',
    'accounting.noJournalEntries': 'Keine Buchungen gefunden',
    'accounting.nonCurrentAssets': 'Anlagevermögen',
    'accounting.notes': 'Notizen',
    'accounting.period': 'Periode',
    'accounting.post': 'Buchen',
    'accounting.price': 'Preis',
    'accounting.purchaseInvoice': 'Einkaufsrechnung',
    'accounting.qty': 'Menge',
    'accounting.reportComingSoon': 'Bericht kommt bald',
    'accounting.reports.incomeStatement': 'Gewinn- und Verlustrechnung',
    'accounting.retainedEarnings': 'Gewinnrücklagen',
    'accounting.revenue': 'Umsatz',
    'accounting.salesInvoice': 'Verkaufsrechnung',
    'accounting.selectAccount': 'Konto auswählen',
    'accounting.status.draft': 'Entwurf',
    'accounting.status.overdue': 'Überfällig',
    'accounting.status.paid': 'Bezahlt',
    'accounting.status.partial': 'Teilweise',
    'accounting.status.pending': 'Ausstehend',
    'accounting.status.posted': 'Gebucht',
    'accounting.status.reversed': 'Storniert',
    'accounting.status.sent': 'Gesendet',
    'accounting.subtotal': 'Zwischensumme',
    'accounting.tax': 'Steuer',
    'translations.key': 'Schlüssel',
    'translations.namespace': 'Namespace',
    'translations.english': 'Englisch',
    'translations.german': 'Deutsch',
    'translations.french': 'Französisch',
    'translations.russian': 'Russisch',
    'translations.noTranslations': 'Keine Übersetzungen gefunden',
    'translations.missingTranslations': 'Fehlende Übersetzungen',
    'translations.title': 'Übersetzungen',
    'translations.subtitle': 'Verwalten Sie Anwendungsübersetzungen und Lokalisierung',
    'masterdata.customerNumber': 'Kundennummer',
    'masterdata.name': 'Name',
    'masterdata.type': 'Typ',
    'masterdata.contact': 'Kontakt',
    'masterdata.creditLimit': 'Kreditlimit',
    'masterdata.title': 'Stammdaten',
    'masterdata.subtitle': 'Verwalten Sie Stammdatenentitäten und -beziehungen',
    'accounting.description': 'Beschreibung',
    'accounting.entryNumber': 'Buchungsnummer',
    'accounting.debit': 'Soll',
    'accounting.credit': 'Haben',
  },
  fr: {
    'nav.dashboard': 'Tableau de bord',
    'nav.companies': 'Entreprises',
    'nav.users': 'Utilisateurs',
    'nav.products': 'Produits',
    'nav.orders': 'Commandes',
    'nav.accounting': 'Comptabilité',
    'nav.masterdata': 'Données de base',
    'nav.translations': 'Traductions',
    'nav.uiBuilder': 'Constructeur d\'interface',
    'nav.settings': 'Paramètres',
    'dashboard.welcome': 'Bon retour, {name} !',
    'dashboard.overview': 'Aperçu',
    'dashboard.totalCompanies': 'Total Entreprises',
    'dashboard.totalUsers': 'Total Utilisateurs',
    'dashboard.revenue': 'Revenus',
    'dashboard.growth': 'Croissance',
    'dashboard.recentUsers': 'Utilisateurs récents',
    'dashboard.noRecentActivity': 'Aucune activité récente',
    'dashboard.recentOrders': 'Commandes récentes',
    'auth.signIn': 'Se connecter',
    'auth.email': 'E-mail',
    'auth.password': 'Mot de passe',
    'auth.forgotPassword': 'Mot de passe oublié ?',
    'auth.demoCredentials': 'Identifiants de démonstration :',
    'settings.title': 'Paramètres',
    'settings.subtitle': 'Gérer votre compte et les préférences de l\'application',
    'settings.appearance': 'Apparence',
    'settings.theme': 'Thème',
    'settings.language': 'Langue',
    'settings.developer': 'Développeur',
    'settings.showTranslationKeys': 'Afficher les clés de traduction',
    'settings.showTranslationKeysDesc': 'Afficher les clés de traduction au lieu du texte traduit pour le débogage',
    'settings.account': 'Compte',
    'users.email': 'E-mail',
    'users.firstName': 'Prénom',
    'users.lastName': 'Nom de famille',
    'users.editUser': 'Modifier l\'utilisateur',
    'users.addUser': 'Ajouter un utilisateur',
    'users.password': 'Mot de passe',
    'users.passwordPlaceholder': 'Laisser vide pour conserver le mot de passe actuel',
    'users.language': 'Langue',
    'users.title': 'Utilisateurs',
    'users.subtitle': 'Gérer les utilisateurs du système et leurs permissions',
    'users.user': 'Utilisateur',
    'uiBuilder.selectComponent': 'Sélectionnez un composant pour modifier ses propriétés',
    'uiBuilder.properties': 'Propriétés',
    'uiBuilder.componentType': 'Type de composant',
    'uiBuilder.content': 'Contenu',
    'uiBuilder.variant': 'Variante',
    'uiBuilder.level': 'Niveau',
    'uiBuilder.label': 'Étiquette',
    'uiBuilder.placeholder': 'Espace réservé',
    'uiBuilder.inputType': 'Type d\'entrée',
    'uiBuilder.height': 'Hauteur',
    'uiBuilder.imageUrl': 'URL de l\'image',
    'uiBuilder.altText': 'Texte alternatif',
    'uiBuilder.title': 'Titre',
    'uiBuilder.noProperties': 'Aucune propriété disponible pour ce composant',
    'uiBuilder.emptyCanvas': 'Toile vide',
    'uiBuilder.dragComponents': 'Faites glisser les composants ici',
    'uiBuilder.components': 'Composants',
    'uiBuilder.basicComponents': 'Composants de base',
    'uiBuilder.formComponents': 'Composants de formulaire',
    'uiBuilder.layoutComponents': 'Composants de mise en page',
    'uiBuilder.dataComponents': 'Composants de données',
    'uiBuilder.unsaved': 'Non enregistré',
    'common.logout': 'Déconnexion',
    'common.active': 'Actif',
    'common.cancel': 'Annuler',
    'common.saving': 'Enregistrement...',
    'common.save': 'Enregistrer',
    'common.all': 'Tous',
    'common.inactive': 'Inactif',
    'common.createdAt': 'Créé le',
    'common.status': 'Statut',
    'common.actions': 'Actions',
    'common.date': 'Date',
    'common.description': 'Description',
    'products.product': 'Produit',
    'products.sku': 'SKU',
    'products.category': 'Catégorie',
    'products.price': 'Prix',
    'products.stock': 'Stock',
    'products.title': 'Produits',
    'products.subtitle': 'Gérer votre catalogue de produits',
    'products.addProduct': 'Ajouter un produit',
    'companies.name': 'Nom',
    'companies.slug': 'Slug',
    'companies.addCompany': 'Ajouter une entreprise',
    'companies.editCompany': 'Modifier l\'entreprise',
    'companies.title': 'Entreprises',
    'companies.subtitle': 'Gérer les informations et paramètres de votre entreprise',
    'orders.orderNumber': 'Numéro de commande',
    'orders.customer': 'Client',
    'orders.items': 'Articles',
    'orders.total': 'Total',
    'orders.createOrder': 'Créer une commande',
    'accounting.title': 'Comptabilité',
    'accounting.subtitle': 'Gérer les factures, paiements et enregistrements financiers',
    'accounting.invoiceNumber': 'Numéro de facture',
    'accounting.customer': 'Client',
    'accounting.type': 'Type',
    'accounting.invoiceDate': 'Date de facture',
    'accounting.dueDate': 'Date d\'échéance',
    'accounting.total': 'Total',
    'accounting.balance': 'Solde',
    'translations.key': 'Clé',
    'translations.namespace': 'Espace de noms',
    'translations.english': 'Anglais',
    'translations.german': 'Allemand',
    'translations.french': 'Français',
    'translations.russian': 'Russe',
    'translations.noTranslations': 'Aucune traduction trouvée',
    'translations.missingTranslations': 'Traductions manquantes',
    'translations.title': 'Traductions',
    'translations.subtitle': 'Gérer les traductions et la localisation de l\'application',
    'masterdata.customerNumber': 'Numéro de client',
    'masterdata.name': 'Nom',
    'masterdata.type': 'Type',
    'masterdata.contact': 'Contact',
    'masterdata.creditLimit': 'Limite de crédit',
    'masterdata.title': 'Données de base',
    'masterdata.subtitle': 'Gérer les entités et relations des données de base',
    'accounting.description': 'Description',
    'accounting.entryNumber': 'Numéro d\'entrée',
    'accounting.debit': 'Débit',
    'accounting.credit': 'Crédit',
  },
  ru: {
    'nav.dashboard': 'Дашборд',
    'nav.companies': 'Компании',
    'nav.users': 'Пользователи',
    'nav.products': 'Продукты',
    'nav.orders': 'Заказы',
    'nav.accounting': 'Бухгалтерия',
    'nav.masterdata': 'Основные данные',
    'nav.translations': 'Переводы',
    'nav.uiBuilder': 'Конструктор интерфейсов',
    'nav.settings': 'Настройки',
    'dashboard.welcome': 'С возвращением, {name}!',
    'dashboard.overview': 'Обзор',
    'dashboard.totalCompanies': 'Всего компаний',
    'dashboard.totalUsers': 'Всего пользователей',
    'dashboard.revenue': 'Выручка',
    'dashboard.growth': 'Рост',
    'dashboard.recentUsers': 'Недавние пользователи',
    'dashboard.noRecentActivity': 'Нет недавней активности',
    'dashboard.recentOrders': 'Недавние заказы',
    'auth.signIn': 'Войти',
    'auth.email': 'Электронная почта',
    'auth.password': 'Пароль',
    'auth.forgotPassword': 'Забыли пароль?',
    'auth.demoCredentials': 'Демо учетные данные:',
    'settings.title': 'Настройки',
    'settings.subtitle': 'Управляйте своим аккаунтом и настройками приложения',
    'settings.appearance': 'Внешний вид',
    'settings.theme': 'Тема',
    'settings.language': 'Язык',
    'settings.developer': 'Разработчик',
    'settings.showTranslationKeys': 'Показать ключи перевода',
    'settings.showTranslationKeysDesc': 'Показывать ключи перевода вместо переведенного текста для отладки',
    'settings.account': 'Аккаунт',
    'users.email': 'Электронная почта',
    'users.firstName': 'Имя',
    'users.lastName': 'Фамилия',
    'users.editUser': 'Редактировать пользователя',
    'users.addUser': 'Добавить пользователя',
    'users.password': 'Пароль',
    'users.passwordPlaceholder': 'Оставьте пустым, чтобы сохранить текущий пароль',
    'users.language': 'Язык',
    'users.title': 'Пользователи',
    'users.subtitle': 'Управление пользователями системы и их разрешениями',
    'users.user': 'Пользователь',
    'uiBuilder.selectComponent': 'Выберите компонент для редактирования его свойств',
    'uiBuilder.properties': 'Свойства',
    'uiBuilder.componentType': 'Тип компонента',
    'uiBuilder.content': 'Содержимое',
    'uiBuilder.variant': 'Вариант',
    'uiBuilder.level': 'Уровень',
    'uiBuilder.label': 'Метка',
    'uiBuilder.placeholder': 'Заполнитель',
    'uiBuilder.inputType': 'Тип ввода',
    'uiBuilder.height': 'Высота',
    'uiBuilder.imageUrl': 'URL изображения',
    'uiBuilder.altText': 'Альтернативный текст',
    'uiBuilder.title': 'Заголовок',
    'uiBuilder.noProperties': 'Нет доступных свойств для этого компонента',
    'uiBuilder.emptyCanvas': 'Пустой холст',
    'uiBuilder.dragComponents': 'Перетащите компоненты сюда',
    'uiBuilder.components': 'Компоненты',
    'uiBuilder.basicComponents': 'Базовые компоненты',
    'uiBuilder.formComponents': 'Компоненты формы',
    'uiBuilder.layoutComponents': 'Компоненты макета',
    'uiBuilder.dataComponents': 'Компоненты данных',
    'uiBuilder.unsaved': 'Не сохранено',
    'common.logout': 'Выйти',
    'common.active': 'Активный',
    'common.cancel': 'Отмена',
    'common.saving': 'Сохранение...',
    'common.save': 'Сохранить',
    'common.all': 'Все',
    'common.inactive': 'Неактивный',
    'common.createdAt': 'Создано',
    'common.status': 'Статус',
    'common.actions': 'Действия',
    'common.date': 'Дата',
    'common.description': 'Описание',
    'products.product': 'Продукт',
    'products.sku': 'SKU',
    'products.category': 'Категория',
    'products.price': 'Цена',
    'products.stock': 'Запас',
    'products.title': 'Продукты',
    'products.subtitle': 'Управление каталогом продуктов',
    'products.addProduct': 'Добавить продукт',
    'companies.name': 'Название',
    'companies.slug': 'Slug',
    'companies.addCompany': 'Добавить компанию',
    'companies.editCompany': 'Редактировать компанию',
    'companies.title': 'Компании',
    'companies.subtitle': 'Управление информацией о компаниях и настройками',
    'orders.orderNumber': 'Номер заказа',
    'orders.customer': 'Клиент',
    'orders.items': 'Товары',
    'orders.total': 'Итого',
    'orders.createOrder': 'Создать заказ',
    'accounting.title': 'Бухгалтерия',
    'accounting.subtitle': 'Управление счетами, платежами и финансовыми записями',
    'accounting.invoiceNumber': 'Номер счета',
    'accounting.customer': 'Клиент',
    'accounting.type': 'Тип',
    'accounting.invoiceDate': 'Дата счета',
    'accounting.dueDate': 'Срок оплаты',
    'accounting.total': 'Итого',
    'accounting.balance': 'Баланс',
    'translations.key': 'Ключ',
    'translations.namespace': 'Пространство имен',
    'translations.english': 'Английский',
    'translations.german': 'Немецкий',
    'translations.french': 'Французский',
    'translations.russian': 'Русский',
    'translations.noTranslations': 'Переводы не найдены',
    'translations.missingTranslations': 'Отсутствующие переводы',
    'translations.title': 'Переводы',
    'translations.subtitle': 'Управление переводами и локализацией приложения',
    'masterdata.customerNumber': 'Номер клиента',
    'masterdata.name': 'Название',
    'masterdata.type': 'Тип',
    'masterdata.contact': 'Контакт',
    'masterdata.creditLimit': 'Кредитный лимит',
    'masterdata.title': 'Основные данные',
    'masterdata.subtitle': 'Управление сущностями и отношениями основных данных',
    'accounting.description': 'Описание',
    'accounting.entryNumber': 'Номер записи',
    'accounting.debit': 'Дебет',
    'accounting.credit': 'Кредит',
  },
};

export function I18nProvider({ children }: { children: React.ReactNode }) {
  const [language, setLanguageState] = useState<Language>(() => {
    const stored = localStorage.getItem('erp-language');
    if (stored && SUPPORTED_LANGUAGES.includes(stored as Language)) {
      return stored as Language;
    }
    // Try to detect from browser
    const browserLang = navigator.language.split('-')[0] as Language;
    return SUPPORTED_LANGUAGES.includes(browserLang) ? browserLang : 'en';
  });

  const [translations, setTranslations] = useState<Map<string, string>>(new Map());
  const currentCompanyId = useAuthStore((state) => state.currentCompanyId);

  const { data, loading } = useQuery(GET_TRANSLATIONS, {
    variables: { language, companyId: currentCompanyId },
    skip: !language,
    errorPolicy: 'ignore',
    onError: () => {},
  });

  useEffect(() => {
    if (data?.translations) {
      const newTranslations = new Map<string, string>();
      data.translations.forEach((t: { key: string; value: string }) => {
        newTranslations.set(t.key, t.value);
      });
      setTranslations(newTranslations);
    }
  }, [data]);

  const setLanguage = useCallback((lang: Language) => {
    setLanguageState(lang);
    localStorage.setItem('erp-language', lang);
    document.documentElement.lang = lang;
  }, []);

  const t = useCallback((key: string, params?: Record<string, string | number>): string => {
    let value = translations.get(key) || FALLBACK_TRANSLATIONS[language]?.[key] || key;
    
    if (params) {
      Object.entries(params).forEach(([paramKey, paramValue]) => {
        value = value.replace(new RegExp(`\\{${paramKey}\\}`, 'g'), String(paramValue));
      });
    }
    
    return value;
  }, [translations, language]);

  return (
    <I18nContext.Provider value={{ t, language, setLanguage, isLoading: loading }}>
      {children}
    </I18nContext.Provider>
  );
}

export function useI18n() {
  const context = useContext(I18nContext);
  if (!context) {
    throw new Error('useI18n must be used within an I18nProvider');
  }
  return context;
}

export { SUPPORTED_LANGUAGES, LANGUAGE_NAMES };
export type { Language };

#!/usr/bin/env bash
set -e

# This script runs at Postgres container initialization via docker-entrypoint-initdb.d
# Creates multiple databases and users for the ERP microservices
# Uses environment variables for passwords (loaded from Docker secrets or env files)

psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<EOSQL
-- Create users and databases (both legacy 'erp_*' names and service expected '*db' names)

-- User Service
	DO $$
	BEGIN
	    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'erp_user') THEN
	        EXECUTE 'CREATE USER erp_user WITH ENCRYPTED PASSWORD ''' || '${ERP_USER_PASSWORD:-postgres}' || '''';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'erp_user') THEN
	        EXECUTE 'CREATE DATABASE erp_user OWNER erp_user';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'userdb') THEN
	        EXECUTE 'CREATE DATABASE userdb OWNER erp_user';
	    END IF;
	END $$;
EOSQL
EOSQL

	-- Accounting Service
	DO $$
	BEGIN
	    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'erp_accounting') THEN
	        EXECUTE 'CREATE USER erp_accounting WITH ENCRYPTED PASSWORD ''' || '${ERP_ACCOUNTING_PASSWORD:-postgres}' || '''';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'erp_accounting') THEN
	        EXECUTE 'CREATE DATABASE erp_accounting OWNER erp_accounting';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'accountingdb') THEN
	        EXECUTE 'CREATE DATABASE accountingdb OWNER erp_accounting';
	    END IF;
	END $$;

	-- Masterdata Service
	DO $$
	BEGIN
	    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'erp_masterdata') THEN
	        EXECUTE 'CREATE USER erp_masterdata WITH ENCRYPTED PASSWORD ''' || '${ERP_MASTERDATA_PASSWORD:-postgres}' || '''';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'erp_masterdata') THEN
	        EXECUTE 'CREATE DATABASE erp_masterdata OWNER erp_masterdata';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'masterdatadb') THEN
	        EXECUTE 'CREATE DATABASE masterdatadb OWNER erp_masterdata';
	    END IF;
	END $$;

	-- Company Service
	DO $$
	BEGIN
	    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'erp_company') THEN
	        EXECUTE 'CREATE USER erp_company WITH ENCRYPTED PASSWORD ''' || '${ERP_COMPANY_PASSWORD:-postgres}' || '''';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'erp_company') THEN
	        EXECUTE 'CREATE DATABASE erp_company OWNER erp_company';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'companydb') THEN
	        EXECUTE 'CREATE DATABASE companydb OWNER erp_company';
	    END IF;
	END $$;

	-- Notification Service
	DO $$
	BEGIN
	    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'erp_notification') THEN
	        EXECUTE 'CREATE USER erp_notification WITH ENCRYPTED PASSWORD ''' || '${ERP_NOTIFICATION_PASSWORD:-postgres}' || '''';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'erp_notification') THEN
	        EXECUTE 'CREATE DATABASE erp_notification OWNER erp_notification';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'notificationdb') THEN
	        EXECUTE 'CREATE DATABASE notificationdb OWNER erp_notification';
	    END IF;
	END $$;

	-- Translation Service
	DO $$
	BEGIN
	    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'erp_translation') THEN
	        EXECUTE 'CREATE USER erp_translation WITH ENCRYPTED PASSWORD ''' || '${ERP_TRANSLATION_PASSWORD:-postgres}' || '''';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'erp_translation') THEN
	        EXECUTE 'CREATE DATABASE erp_translation OWNER erp_translation';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'translationdb') THEN
	        EXECUTE 'CREATE DATABASE translationdb OWNER erp_translation';
	    END IF;
	END $$;

	-- Templates Service
	DO $$
	BEGIN
	    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'erp_templates') THEN
	        EXECUTE 'CREATE USER erp_templates WITH ENCRYPTED PASSWORD ''' || '${ERP_TEMPLATES_PASSWORD:-postgres}' || '''';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'erp_templates') THEN
	        EXECUTE 'CREATE DATABASE erp_templates OWNER erp_templates';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'templatesdb') THEN
	        EXECUTE 'CREATE DATABASE templatesdb OWNER erp_templates';
	    END IF;
	END $$;

	-- Edifact Service
	DO $$
	BEGIN
	    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'erp_edifact') THEN
	        EXECUTE 'CREATE USER erp_edifact WITH ENCRYPTED PASSWORD ''' || '${ERP_EDIFACT_PASSWORD:-postgres}' || '''';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'erp_edifact') THEN
	        EXECUTE 'CREATE DATABASE erp_edifact OWNER erp_edifact';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'edifactdb') THEN
	        EXECUTE 'CREATE DATABASE edifactdb OWNER erp_edifact';
	    END IF;
	END $$;

	-- Scripting Service
	DO $$
	BEGIN
	    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'erp_scripting') THEN
	        EXECUTE 'CREATE USER erp_scripting WITH ENCRYPTED PASSWORD ''' || '${ERP_SCRIPTING_PASSWORD:-postgres}' || '''';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'erp_scripting') THEN
	        EXECUTE 'CREATE DATABASE erp_scripting OWNER erp_scripting';
	    END IF;
	    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'scriptingdb') THEN
	        EXECUTE 'CREATE DATABASE scriptingdb OWNER erp_scripting';
	    END IF;
	END $$;
EOSQL

= ERP System Scripts Documentation

:toc: auto
:hardbreaks-option: true
:source-highlighter: rouge
:toclevels: 2

== Overview

This directory contains scripts for managing the ERP System development and deployment lifecycle.

=== Script Overview

|===
| Script | Purpose | Status

| link:start-local.sh[start-local.sh]
| Start the complete system locally with health checks
| âœ… Production Ready

| link:stop-local.sh[stop-local.sh]
| Stop all local containers
| âœ… Production Ready

| link:deploy-and-push.sh[deploy-and-push.sh]
| Build and push containers to GitHub Container Registry
| âœ… Production Ready

| link:deploy-production.sh[deploy-production.sh]
| Deploy the system to a production server
| âœ… Production Ready

| link:quick-test.sh[quick-test.sh]
| Quick validation tests for the startup script
| âœ… Production Ready

| link:ubuntu-dev-install.sh[ubuntu-dev-install.sh]
| Ubuntu development environment setup
| âœ… Production Ready

| link:test-startup-script.sh[test-startup-script.sh]
| Comprehensive startup script testing
| âœ… Production Ready
|===

== Local Development Setup

=== Prerequisites

* Docker and Docker Compose installed and running
* At least 4GB of available RAM
* Ports 4000, 5000, 5173, 5432-5439, 9000-9001 available

=== Quick Start

[source,bash]
----
# Start the complete system
./scripts/start-local.sh

# Check system status
./scripts/start-local.sh status

# Stop all services
./scripts/stop-local.sh
----

=== Access Points

After startup, you can access:

* **Frontend**: http://localhost:5173[http://localhost:5173]
* **GraphQL Gateway**: http://localhost:4000/graphql[http://localhost:4000/graphql]
* **UserService API**: http://localhost:5000/graphql[http://localhost:5000/graphql]
* **MinIO Storage**: http://localhost:9001[http://localhost:9001] (admin/admin)

=== Login Credentials

* **Email**: admin@erp-system.local
* **Password**: Admin123!

=== Services Status

The script starts the core working services:

* âœ… UserService (.NET) - Authentication & user management (active in federation)
* âœ… Gateway (Node.js) - GraphQL federation (configured for UserService only)
* âœ… Frontend (React/Vite) - Web interface
* âœ… Databases (PostgreSQL) - Data persistence
* âœ… MinIO - File storage
* âš ï¸ TranslationService - Java build issues, not in federation
* âš ï¸ CompanyService - Java build issues, not in federation
* âš ï¸ AccountingService - Missing DTOs, not in federation
* âš ï¸ MasterdataService - Fixed but needs rebuild, not in federation
* âš ï¸ ShopService - Not tested, not in federation

== start-local.sh

Start the complete ERP system locally with comprehensive health checks.

=== Features

* ðŸ” Pre-flight checks for Docker and compose files
* ðŸŒ Network and port availability verification (14 ports)
* ðŸ—„ï¸ PostgreSQL initialization and readiness checks
* âœ… Health checks for all microservices
* ðŸ“Š GraphQL endpoint validation
* ðŸŽ¨ Frontend availability verification
* ðŸ”€ Apollo Gateway federation with automatic retries
* ðŸ“‹ Final system verification and status reporting

=== Usage

[source,bash]
----
# Start the system with all checks
./scripts/start-local.sh

# Check system status
./scripts/start-local.sh status

# View service ports
./scripts/start-local.sh ports

# View logs for specific service
./scripts/start-local.sh logs gateway

# Show help
./scripts/start-local.sh help
----

=== 8-Phase Startup Process

1. **Phase 1: Pre-flight Checks** - Docker and compose validation
2. **Phase 2: Network Checks** - Port availability verification
3. **Phase 3: Infrastructure** - PostgreSQL startup
4. **Phase 4: Core Services** - Start 8 microservices
5. **Phase 5: Health Verification** - REST and GraphQL endpoint checks
6. **Phase 6: Frontend** - React UI startup
7. **Phase 7: Gateway** - Apollo Gateway federation (LAST)
8. **Phase 8: Final Verification** - Complete system health check

=== Exit Codes

* `0` - System started successfully
* `1` - Critical error (check output for details)

== stop-local.sh

Stop all local containers and clean up the system.

=== Usage

[source,bash]
----
# Stop all services
./scripts/stop-local.sh

# Force remove containers and volumes
docker compose down -v
----

== deploy-and-push.sh

Build all ERP containers and push them to GitHub Container Registry.

=== Features

* ðŸ—ï¸ Build all 11 microservices
* ðŸ“¦ Push to private GitHub Container Registry (ghcr.io)
* ðŸ”„ Support for parallel builds
* ðŸ”’ Secure token-based authentication
* ðŸ“‹ Configuration file support (JSON)
* ðŸ” Dry-run mode for preview
* âš¡ Interactive or command-line configuration

=== Usage

==== Interactive Mode

[source,bash]
----
./scripts/deploy-and-push.sh
# Prompts for: GitHub username, token, version
----

==== Command-line Arguments

[source,bash]
----
./scripts/deploy-and-push.sh \
  --username JCTRoth \
  --token ghp_your_token_here \
  --version 1.0.0
----

==== Configuration File

[source,bash]
----
./scripts/deploy-and-push.sh --config build-config.json
----

==== Dry-run (Preview)

[source,bash]
----
./scripts/deploy-and-push.sh --dry-run --username JCTRoth
----

==== Parallel Builds

[source,bash]
----
./scripts/deploy-and-push.sh --parallel 4 --username JCTRoth --token ghp_xxx
----

=== Configuration File Example

[source,json]
----
{
  "github_username": "JCTRoth",
  "github_token": "ghp_your_token_here",
  "registry_url": "ghcr.io",
  "image_version": "1.0.0",
  "parallel_builds": 2
}
----

=== Services Built

* âœ… frontend
* âœ… gateway
* âœ… user-service (.NET)
* âœ… shop-service (.NET)
* âœ… accounting-service (.NET)
* âœ… masterdata-service (.NET)
* âœ… orders-service (.NET)
* âœ… company-service (Java)
* âœ… translation-service (Java)
* âœ… notification-service (Java)
* âœ… scripting-service (Java)

== deploy-production.sh

Deploy the ERP system to a production server with SSL/HTTPS support.

=== Features

* ðŸš€ Automated production deployment
* ðŸ” Let's Encrypt SSL certificate setup
* ðŸ”„ HTTP to HTTPS redirect configuration
* âœ… Automated health verification
* ðŸ“Š Service status checking
* ðŸ” Post-deployment validation
* ðŸ“‹ Configuration file support
* ðŸ”„ Interactive or command-line configuration

=== Prerequisites

* SSH access to the production server
* Docker and Docker Compose on the server
* Open ports: 80 (HTTP), 443 (HTTPS)
* Email for Let's Encrypt notifications
* GitHub Container Registry token

=== Usage

==== Interactive Mode

[source,bash]
----
./scripts/deploy-production.sh
# Prompts for: server, domain, email, token, password
----

==== Command-line Arguments

[source,bash]
----
./scripts/deploy-production.sh \
  --server prod.example.com \
  --domain erp.example.com \
  --email admin@example.com \
  --registry-token ghp_xxx \
  --db-password MySecurePassword123
----

==== Configuration File

[source,bash]
----
./scripts/deploy-production.sh --config deploy-config.json
----

==== Dry-run (Preview)

[source,bash]
----
./scripts/deploy-production.sh \
  --server prod.example.com \
  --domain erp.example.com \
  --dry-run
----

=== Configuration File Example

[source,json]
----
{
  "deploy_server": "192.168.1.100",
  "deploy_domain": "erp.example.com",
  "deploy_username": "root",
  "deploy_ssh_key": "~/.ssh/id_rsa",
  "registry_url": "ghcr.io",
  "registry_username": "JCTRoth",
  "registry_token": "ghp_token_here",
  "image_version": "1.0.0",
  "letsencrypt_email": "admin@example.com",
  "db_password": "secure_password"
}
----

=== Deployment Steps

1. Validates SSH connectivity
2. Creates docker-compose configuration
3. Sets up Let's Encrypt SSL certificates
4. Authenticates with GHCR
5. Pulls latest container images
6. Starts all services
7. Verifies deployment and health checks
8. Displays post-deployment information

=== Post-Deployment Commands

[source,bash]
----
# SSH into server
ssh root@prod.example.com

# Navigate to deployment directory
cd /opt/erp-system

# Check service status
docker compose ps

# View logs
docker compose logs -f

# Restart services
docker compose restart gateway

# Stop services
docker compose down
----

== quick-test.sh

Validate the startup script with automated tests.

=== Tests Performed

* âœ… Script syntax validation
* âœ… Docker availability
* âœ… Compose file verification
* âœ… Command functionality (help, status, ports)
* âœ… Service health checks
* âœ… GraphQL endpoint verification
* âœ… Script structure validation

=== Usage

[source,bash]
----
# Run all tests
./scripts/quick-test.sh

# Expected output: "20 passed, 0 failed"
----

== Environment Variables Reference

=== Build Script (deploy-and-push.sh)

[source,bash]
----
export GITHUB_USERNAME="JCTRoth"
export GITHUB_TOKEN="ghp_xxx"
export REGISTRY_URL="ghcr.io"
export IMAGE_VERSION="1.0.0"
----

=== Deploy Script (deploy-production.sh)

[source,bash]
----
export DEPLOY_SERVER="prod.example.com"
export DEPLOY_DOMAIN="erp.example.com"
export DEPLOY_USERNAME="root"
export DEPLOY_SSH_KEY="~/.ssh/id_rsa"
export REGISTRY_USERNAME="JCTRoth"
export REGISTRY_TOKEN="ghp_xxx"
export IMAGE_VERSION="1.0.0"
export LETSENCRYPT_EMAIL="admin@example.com"
export DB_PASSWORD="secure_password"
----

== GitHub Actions CI/CD

The deployment workflow is defined in `.github/workflows/deploy.yml` and is triggered by:

* **Tag push**: Pushing a tag like `v1.0.0` automatically builds and deploys
* **Manual trigger**: Manually run the workflow with a custom version

=== Required Secrets

Add these secrets to your GitHub repository settings:

[source]
----
DEPLOY_SERVER          - Production server hostname/IP
DEPLOY_DOMAIN          - Domain name for the application
DEPLOY_USERNAME        - SSH username (usually "root")
DEPLOY_SSH_KEY         - SSH private key for authentication
DEPLOY_EMAIL           - Email for Let's Encrypt notifications
DB_PASSWORD            - PostgreSQL password
----

=== Trigger Deployment

[source,bash]
----
# Push a tag to trigger CI/CD
git tag v1.0.0
git push origin v1.0.0

# Or manually trigger in GitHub Actions UI
# Actions > Deploy to Production > Run workflow
----

== Troubleshooting

=== start-local.sh

==== Problem: Services not starting

[source,bash]
----
# Check Docker is running
docker ps

# View service logs
docker compose logs user-service

# Restart gateway specifically
docker compose restart gateway
----

=== deploy-and-push.sh

==== Problem: Authentication fails

[source,bash]
----
# Verify token has write:packages scope
# Check GitHub username is correct
# Ensure Docker is logged in
docker logout ghcr.io
echo "ghp_your_token" | docker login ghcr.io -u JCTRoth --password-stdin
----

=== deploy-production.sh

==== Problem: SSH connection fails

[source,bash]
----
# Test SSH connectivity
ssh -i ~/.ssh/id_rsa root@prod.example.com "echo test"

# Check key permissions
chmod 600 ~/.ssh/id_rsa

# Add server to known_hosts
ssh-keyscan -H prod.example.com >> ~/.ssh/known_hosts
----

== Development Workflow

1. Start the system: `./scripts/start-local.sh`
2. Make code changes
3. Services will hot-reload automatically (for supported services)
4. Stop when done: `./scripts/stop-local.sh`

== Additional Resources

* link:../docs/DEPLOYMENT_GUIDE.md[Deployment Guide] - Comprehensive deployment documentation
* link:../docs/ARCHITECTURE_DECISION_BRAND_CATEGORY.md[Architecture Documentation] - System architecture
* link:../docs/BACKEND.md[Backend Development] - Backend service details
* link:../docs/FRONTEND.md[Frontend Development] - Frontend information

== License

These scripts are part of the ERP System project and follow the same license.

== Support

For issues or questions:

1. Check the link:../docs/DEPLOYMENT_GUIDE.md[Deployment Guide]
2. Review script help: `./scripts/deploy-and-push.sh --help`
3. Check logs: `docker compose logs`
4. View GitHub Actions workflows: `.github/workflows/`

---

*Last updated: January 9, 2026*